<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Buddy - AIËã±‰ºöË©±„Å¨„ÅÑ„Åê„Çã„Åø</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .teddy-bear {
            font-size: 100px;
            margin-bottom: 20px;
            animation: bounce 2s infinite ease-in-out;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
        }

        @keyframes bounce {
            0%, 100% { 
                transform: translateY(0) rotate(-5deg); 
            }
            50% { 
                transform: translateY(-20px) rotate(5deg); 
            }
        }

        .title {
            color: white;
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        .api-key-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .api-key-section h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .api-key-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .save-key-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-key-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .talk-button {
            font-size: 20px;
            padding: 20px 40px;
            border-radius: 50px;
            border: none;
            background: white;
            color: #667eea;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
            min-width: 200px;
        }

        .talk-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }

        .talk-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .talk-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .talk-button.listening {
            background: #ff6b6b;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .talk-button.speaking {
            background: #51cf66;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { 
                transform: scale(1); 
            }
            50% { 
                transform: scale(1.05); 
            }
        }

        .conversation {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .message {
            background: white;
            padding: 15px 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: left;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .ai-message {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
        }

        .label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .text {
            font-size: 18px;
            color: #333;
            line-height: 1.5;
        }

        .reset-button {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .reset-button:hover {
            background: white;
            color: #667eea;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 15px;
            color: white;
            font-size: 14px;
        }

        .instructions p {
            margin: 5px 0;
        }

        .error-message {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .hidden {
            display: none;
        }

        /* „É¢„Éê„Ç§„É´ÂØæÂøú */
        @media (max-width: 600px) {
            .teddy-bear {
                font-size: 80px;
            }
            
            .title {
                font-size: 28px;
            }
            
            .talk-button {
                font-size: 18px;
                padding: 18px 35px;
            }
            
            .text {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="container">
            <div class="teddy-bear">üß∏</div>
            <h1 class="title">English Buddy</h1>

            <!-- API„Ç≠„ÉºÂÖ•Âäõ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div id="apiKeySection" class="api-key-section">
                <h3>üîë Anthropic API„Ç≠„Éº„ÇíÂÖ•Âäõ</h3>
                <input 
                    type="password" 
                    id="apiKeyInput" 
                    class="api-key-input" 
                    placeholder="sk-ant-api03-..."
                >
                <button class="save-key-button" onclick="saveApiKey()">‰øùÂ≠ò„Åó„Å¶ÈñãÂßã</button>
                <p style="color: #666; font-size: 12px; margin-top: 10px;">
                    ‚Äª API„Ç≠„Éº„ÅØ <a href="https://console.anthropic.com/" target="_blank" style="color: #667eea;">console.anthropic.com</a> „ÅßÂèñÂæó„Åß„Åç„Åæ„Åô
                </p>
            </div>

            <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ÔºàÂàùÊúü„ÅØÈùûË°®Á§∫Ôºâ -->
            <div id="mainApp" class="hidden">
                <div id="errorMessage" class="error-message hidden"></div>

                <button 
                    id="talkButton"
                    onclick="startListening()" 
                    class="talk-button"
                >
                    üé§ Tap to Talk
                </button>

                <div id="conversation" class="conversation"></div>

                <button id="resetButton" class="reset-button hidden" onclick="resetConversation()">
                    üîÑ New Conversation
                </button>

                <div class="instructions">
                    <p>üì± „Çπ„Éû„Éõ„Çí„Å¨„ÅÑ„Åê„Çã„Åø„ÅÆ„Éù„Ç±„ÉÉ„Éà„Å´ÂÖ•„Çå„Å¶‰Ωø„Å£„Å¶„Å≠ÔºÅ</p>
                    <p>üé§ „Éú„Çø„É≥„ÇíÊäº„Åó„Å¶Ëã±Ë™û„ÅßË©±„Åó„Åã„Åë„Çà„ÅÜ</p>
                    <p>üí° Chrome „Åæ„Åü„ÅØ Edge „Éñ„É©„Ç¶„Ç∂„Çí‰Ωø„Å£„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let ANTHROPIC_API_KEY = '';
        let conversationHistory = [];
        let isListening = false;
        let isSpeaking = false;

        // API„Ç≠„Éº„Çí‰øùÂ≠ò
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();

            if (!key) {
                showError('API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!key.startsWith('sk-ant-')) {
                showError('Ê≠£„Åó„ÅÑAPI„Ç≠„ÉºÂΩ¢Âºè„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„ÇìÔºàsk-ant-„ÅßÂßã„Åæ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„ÅôÔºâ');
                return;
            }

            ANTHROPIC_API_KEY = key;
            localStorage.setItem('anthropic_api_key', key);

            // UIÂàá„ÇäÊõø„Åà
            document.getElementById('apiKeySection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´API„Ç≠„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('anthropic_api_key');
            if (savedKey) {
                ANTHROPIC_API_KEY = savedKey;
                document.getElementById('apiKeySection').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
            }
        });

        // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞
        function updateButtonState(state) {
            const button = document.getElementById('talkButton');
            button.className = 'talk-button';
            
            if (state === 'listening') {
                isListening = true;
                button.classList.add('listening');
                button.textContent = 'üé§ Listening...';
                button.disabled = true;
            } else if (state === 'speaking') {
                isSpeaking = true;
                button.classList.add('speaking');
                button.textContent = 'üîä Speaking...';
                button.disabled = true;
            } else {
                isListening = false;
                isSpeaking = false;
                button.textContent = 'üé§ Tap to Talk';
                button.disabled = false;
            }
        }

        // Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã
        function startListening() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                showError('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™çË≠ò„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome„Åæ„Åü„ÅØEdge„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = () => {
                updateButtonState('listening');
                console.log('Èü≥Â£∞Ë™çË≠òÈñãÂßã');
            };

            recognition.onresult = async (event) => {
                const text = event.results[0][0].transcript;
                console.log('Ë™çË≠ò„Åï„Çå„Åü„ÉÜ„Ç≠„Çπ„Éà:', text);
                
                // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                addMessage('user', text);
                
                // Claude API„ÅßÂøúÁ≠î„ÇíÁîüÊàê
                await getAIResponse(text);
            };

            recognition.onerror = (event) => {
                console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
                updateButtonState('idle');
                
                if (event.error === 'no-speech') {
                    showError('Èü≥Â£∞„ÅåËÅû„Åì„Åà„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else if (event.error === 'not-allowed') {
                    showError('„Éû„Ç§„ÇØ„ÅÆË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                } else {
                    showError('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº: ' + event.error);
                }
            };

            recognition.onend = () => {
                if (isListening) {
                    updateButtonState('idle');
                }
                console.log('Èü≥Â£∞Ë™çË≠òÁµÇ‰∫Ü');
            };

            recognition.start();
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
        function addMessage(type, text) {
            const conversation = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const label = type === 'user' ? 'You said:' : 'Teddy says:';
            
            messageDiv.innerHTML = `
                <div class="label">${label}</div>
                <div class="text">${text}</div>
            `;
            
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;

            // „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥„ÇíË°®Á§∫
            document.getElementById('resetButton').classList.remove('hidden');
        }

        // Claude API„ÅßÂøúÁ≠î„ÇíÂèñÂæó
        async function getAIResponse(userMessage) {
            try {
                updateButtonState('speaking');

                // ‰ºöË©±Â±•Ê≠¥„Çí‰ΩúÊàê
                const messages = [
                    ...conversationHistory,
                    { role: 'user', content: userMessage }
                ];

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': ANTHROPIC_API_KEY,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-haiku-20241022',
                        max_tokens: 100,
                        system: `You are a friendly, encouraging English teacher teddy bear helping a Japanese child learn English. 

Rules:
- Keep responses very short (1-2 sentences maximum)
- Use simple, basic English words
- Be warm and encouraging
- Ask simple follow-up questions sometimes
- Praise their efforts
- If they make a mistake, gently correct by repeating correctly
- Use child-friendly topics: animals, colors, food, family, toys`,
                        messages: messages.slice(-6) // ÊúÄÊñ∞3ÂæÄÂæ©„ÅÆ„Åø‰øùÊåÅ
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                const aiResponse = data.content[0].text;
                
                console.log('AIÂøúÁ≠î:', aiResponse);

                // AI„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                addMessage('ai', aiResponse);

                // ‰ºöË©±Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                conversationHistory.push(
                    { role: 'user', content: userMessage },
                    { role: 'assistant', content: aiResponse }
                );

                // Èü≥Â£∞„ÅßË™≠„Åø‰∏ä„Åí
                speak(aiResponse);

            } catch (error) {
                console.error('APIÂëº„Å≥Âá∫„Åó„Ç®„É©„Éº:', error);
                showError('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
                updateButtonState('idle');
            }
        }

        // Èü≥Â£∞ÂêàÊàê
        function speak(text) {
            // Êó¢Â≠ò„ÅÆÈü≥Â£∞„ÇíÂÅúÊ≠¢
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.85; // Â∞ë„Åó„ÇÜ„Å£„Åè„Çä
            utterance.pitch = 1.2; // Â∞ë„ÅóÈ´ò„ÇÅ„ÅßË¶™„Åó„Åø„ÇÑ„Åô„Åè
            utterance.volume = 1.0;

            utterance.onend = () => {
                updateButtonState('idle');
                console.log('Èü≥Â£∞ÂÜçÁîüÁµÇ‰∫Ü');
            };

            utterance.onerror = (event) => {
                console.error('Èü≥Â£∞ÂêàÊàê„Ç®„É©„Éº:', event);
                updateButtonState('idle');
            };

            window.speechSynthesis.speak(utterance);
        }

        // ‰ºöË©±„Çí„É™„Çª„ÉÉ„Éà
        function resetConversation() {
            conversationHistory = [];
            document.getElementById('conversation').innerHTML = '';
            document.getElementById('resetButton').classList.add('hidden');
            window.speechSynthesis.cancel();
            updateButtonState('idle');
        }
    </script>
</body>
</html>
